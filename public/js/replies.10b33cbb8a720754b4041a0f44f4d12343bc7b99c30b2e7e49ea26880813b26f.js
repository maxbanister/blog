(()=>{var R="https://mastodon.social/authorize_interaction?uri=";async function d(o,t,e){console.log("fetching records for handle",o+t),bridgyRequestURI="https://atproto.brid.gy/xrpc/com.atproto.repo.listRecords?repo=",bridgyRequestURI+=o+"&collection=app.bsky.feed.post",t&&(bridgyRequestURI+="&cursor="+t);let n=await(await fetch(bridgyRequestURI,{headers:{Accept:"application/json"}})).json();if(console.log(n),!n){console.log("could not get records for",o+t);return}for(let a of n.records)if(a.value.bridgyOriginalUrl==e)return"https://bsky.app/profile/"+a.uri.replace("at://","").replace("app.bsky.feed.post","post");if(n.cursor)return d(o,n.cursor)}async function N(){let[o,t]=document.querySelectorAll("#social-links > a");o.href=R+window.location.href,t.href=await d("maxbanister.com","","https://maxbanister.com"+window.location.pathname);let e=await fetch(window.location.pathname+"replies");if(!e.ok){console.log(e.statusText);return}let r=await e.json();console.log(r),b(document.getElementById("replies"),r.items)}function b(o,t){if(t)for(let e of t){let r=e.type=="Tombstone";e.url=r?"":e.url.replace("https://fed.brid.gy/r/",""),e.actor||={};let n=T(o,{id:e.id,name:e.actor.name,shortName:e.actor.preferredUsername,host:r?"":new URL(e.actor.id).hostname,picURL:e.actor.icon,userURL:e.actor.id,date:e.published,editDate:e.updated,opURL:e.url,content:e.content},r);b(n,e.replies.items)}}function T(o,t,e){let{id:r,name:n,shortName:a,host:l,picURL:w,userURL:U,date:A,editDate:f,opURL:c,content:L}=t,u={dateStyle:"long",timeStyle:"short"},m=new Intl.DateTimeFormat(void 0,u).format(new Date(A));if(f){let p=new Intl.DateTimeFormat(void 0,u).format(new Date(f));m+=" (Edited: "+p+")"}let s=document.getElementById("reply-template").content.cloneNode(!0),y=s.firstElementChild,[S,k]=s.querySelectorAll(".reply-profile-info a span");S.textContent=e?"":"@"+a,k.textContent=e?"":"@"+l;let q=y.getElementsByClassName("reply-contents")[0];q.innerHTML=e?'<i style="color: grey">[deleted]</i>':L;let h=s.querySelector(".reply-top > img");h.src=e?"":w,e&&(h.alt="");let E=s.querySelector(".reply-profile-info > a");E.href=U;let[I,x]=s.querySelectorAll(".reply-profile-info > span");I.textContent=e?"[deleted]":n||a,x.textContent=m;let D=s.querySelector(".reply-op-button > a");D.href=c;let[g,i]=s.querySelectorAll(".reply-controls > a");if(!c||new URL(c).host==="mastodon.social"?g.href=c:g.href=R+r,l==="bsky.brid.gy")i.href=c;else{let p=a+"."+l+".ap.brid.gy";i.addEventListener("click",async C=>{if(console.log(i.href),i.getAttribute("href")==="#"){C.preventDefault();let B=await d(p,"",c);i.href=B,i.click()}})}return o.appendChild(s),y}async function v(){return N()}v();})();

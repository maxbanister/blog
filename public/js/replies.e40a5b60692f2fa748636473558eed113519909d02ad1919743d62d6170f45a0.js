(()=>{var g="https://mastodon.social/authorize_interaction?uri=";async function p(o,t,e){console.log("fetching records for handle",o+t),bridgyRequestURI="https://atproto.brid.gy/xrpc/com.atproto.repo.listRecords?repo=",bridgyRequestURI+=o+"&collection=app.bsky.feed.post",t&&(bridgyRequestURI+="&cursor="+t);let n=await(await fetch(bridgyRequestURI,{headers:{Accept:"application/json"}})).json();if(console.log(n),!n){console.log("could not get records for",o+t);return}for(let a of n.records)if(a.value.bridgyOriginalUrl==e)return"https://bsky.app/profile/"+a.uri.replace("at://","").replace("app.bsky.feed.post","post");if(n.cursor)return p(o,n.cursor)}async function B(){let[o,t]=document.querySelectorAll("#social-links > a");o.href=g+window.location.href,t.href=await p("maxbanister.com","","https://maxbanister.com"+window.location.pathname);let e=await fetch(window.location.pathname+"replies");if(!e.ok){console.log(e.statusText);return}let s=await e.json();R(document.getElementById("replies"),s.items)}function R(o,t){if(t)for(let e of t){e.url=e.url.replace("https://fed.brid.gy/r/","");let s=N(o,{id:e.id,name:e.actor.name,shortName:e.actor.preferredUsername,host:new URL(e.actor.id).hostname,picURL:e.actor.icon,userURL:e.actor.id,date:e.published,editDate:e.updated,opURL:e.url,content:e.content});R(s,e.replies.items)}}function N(o,t){let{id:e,name:s,shortName:n,host:a,picURL:d,userURL:b,date:w,editDate:f,opURL:i,content:U}=t,u={dateStyle:"long",timeStyle:"short"},m=new Intl.DateTimeFormat(void 0,u).format(new Date(w));if(f){let l=new Intl.DateTimeFormat(void 0,u).format(new Date(f));m+=" (Edited: "+l+")"}let r=document.getElementById("reply-template").content.cloneNode(!0),y=r.firstElementChild,[A,L]=r.querySelectorAll(".reply-profile-info a span");A.textContent="@"+n,L.textContent="@"+a;let S=y.getElementsByClassName("reply-contents")[0];S.innerHTML=U;let k=r.querySelector(".reply-top > img");k.src=d;let q=r.querySelector(".reply-profile-info > a");q.href=b;let[E,I]=r.querySelectorAll(".reply-profile-info > span");E.textContent=s||n,I.textContent=m;let x=r.querySelector(".reply-op-button > a");x.href=i;let[h,c]=r.querySelectorAll(".reply-controls > a");if(new URL(i).host==="mastodon.social"?h.href=i:h.href=g+e,a==="bsky.brid.gy")c.href=i;else{let l=n+"."+a+".ap.brid.gy";c.addEventListener("click",async D=>{if(console.log(c.href),c.getAttribute("href")==="#"){D.preventDefault();let C=await p(l,"",i);c.href=C,c.click()}})}return o.appendChild(r),y}async function v(){return B()}v();})();

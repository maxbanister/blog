(()=>{var U="https://mastodon.social/authorize_interaction?uri=";function v(o){let t=0;for(let s of o)t=(t<<5)-t+s.charCodeAt(0),t|=0;let e=t>>0&255,r=t>>8&255,n=t>>16&255;return"rgb("+e+","+r+","+n+",0.5)"}async function f(o,t,e){console.log("fetching records for handle",o+t),bridgyRequestURI="https://atproto.brid.gy/xrpc/com.atproto.repo.listRecords?repo=",bridgyRequestURI+=o+"&collection=app.bsky.feed.post",t&&(bridgyRequestURI+="&cursor="+t);let n=await(await fetch(bridgyRequestURI,{headers:{Accept:"application/json"}})).json();if(console.log(n),!n){console.log("could not get records for",o+t);return}for(let s of n.records)if(s.value.bridgyOriginalUrl==e)return"https://bsky.app/profile/"+s.uri.replace("at://","").replace("app.bsky.feed.post","post");if(n.cursor)return f(o,n.cursor)}async function B(){let[o,t]=document.querySelectorAll("#social-links > a");o.href=U+window.location.href,t.href=await f("maxbanister.com","","https://maxbanister.com"+window.location.pathname);let e=await fetch(window.location.pathname+"replies");if(!e.ok){console.log(e.statusText);return}let r=await e.json();console.log(r),x(document.getElementById("replies"),r.items)}function x(o,t){if(t)for(let e of t){let r=e.type=="Tombstone";e.url=r?"javascript:void(0)":e.url.replace("https://fed.brid.gy/r/",""),e.actor||={};let n=N(o,{id:e.id,name:e.actor.name,shortName:e.actor.preferredUsername,host:r?"":new URL(e.actor.id).hostname,picURL:e.actor.icon,userURL:e.actor.id,date:e.published,editDate:e.updated,opURL:e.url,content:e.content},r);x(n,e.replies.items)}}function N(o,t,e){let{id:r,name:n,shortName:s,host:l,picURL:A,userURL:u,date:k,editDate:m,opURL:i,content:I}=t,y={dateStyle:"long",timeStyle:"short"},h=new Intl.DateTimeFormat(void 0,y).format(new Date(k));if(m){let d=new Intl.DateTimeFormat(void 0,y).format(new Date(m));h+=" (Edited: "+d+")"}let c=document.getElementById("reply-template").content.cloneNode(!0),g=c.firstElementChild,[R,b]=c.querySelectorAll(".reply-profile-info a span");R.textContent=e?"":"@"+s,b.textContent=e?"":"@"+l;let L=g.getElementsByClassName("reply-contents")[0];L.innerHTML=e?'<i style="color: grey">[deleted]</i>':I;let p=c.querySelector(".reply-top > img");p.src=e?"":"/image_proxy/"+encodeURIComponent(A)+"/"+encodeURIComponent(u),p.style.backgroundColor=v(R.innerText+b.innerText),e&&(p.alt="");let S=c.querySelector(".reply-profile-info > a");S.href=u;let[q,C]=c.querySelectorAll(".reply-profile-info > span");q.textContent=e?"[deleted]":n||s,C.textContent=h;let E=c.querySelector(".reply-op-button > a");E.href=i;let[w,a]=c.querySelectorAll(".reply-controls > a");if(new URL(i).host==="mastodon.social"?w.href=i:w.href=U+r,e||l==="bsky.brid.gy")a.href=i;else{let d=s+"."+l+".ap.brid.gy";a.addEventListener("click",async D=>{if(console.log(a.href),a.getAttribute("href")==="#"){D.preventDefault();let T=await f(d,"",i);a.href=T,a.click()}})}return o.appendChild(c),g}async function j(){return B()}j();})();

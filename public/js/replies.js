(()=>{var w="https://mastodon.social/authorize_interaction?uri=";function v(o){let t=0;for(let s of o)t=(t<<5)-t+s.charCodeAt(0),t|=0;let e=t>>0&255,n=t>>8&255,r=t>>16&255;return"rgb("+e+","+n+","+r+",0.5)"}async function f(o,t,e){console.log("fetching records for handle",o+t),bridgyRequestURI="https://atproto.brid.gy/xrpc/com.atproto.repo.listRecords?repo=",bridgyRequestURI+=o+"&collection=app.bsky.feed.post",t&&(bridgyRequestURI+="&cursor="+t);let r=await(await fetch(bridgyRequestURI,{headers:{Accept:"application/json"}})).json();if(console.log(r),!r){console.log("could not get records for",o+t);return}for(let s of r.records)if(s.value.bridgyOriginalUrl==e)return"https://bsky.app/profile/"+s.uri.replace("at://","").replace("app.bsky.feed.post","post");if(r.cursor)return f(o,r.cursor)}async function B(){let[o,t]=document.querySelectorAll("#social-links > a");o.href=w+window.location.href,t.href=await f("maxbanister.com","","https://maxbanister.com"+window.location.pathname);let e=await fetch(window.location.pathname+"replies");if(!e.ok){console.log(e.statusText);return}let n=await e.json();console.log(n),U(document.getElementById("replies"),n.items)}function U(o,t){if(t)for(let e of t){let n=e.type=="Tombstone";e.url=n?"javascript:void(0)":e.url.replace("https://fed.brid.gy/r/",""),e.actor||={};let r=N(o,{id:e.id,name:e.actor.name,shortName:e.actor.preferredUsername,host:n?"":new URL(e.actor.id).hostname,picURL:e.actor.icon,userURL:e.actor.id,date:e.published,editDate:e.updated,opURL:e.url,content:e.content},n);U(r,e.replies.items)}}function N(o,t,e){let{id:n,name:r,shortName:s,host:l,picURL:x,userURL:A,date:k,editDate:u,opURL:i,content:I}=t,m={dateStyle:"long",timeStyle:"short"},y=new Intl.DateTimeFormat(void 0,m).format(new Date(k));if(u){let d=new Intl.DateTimeFormat(void 0,m).format(new Date(u));y+=" (Edited: "+d+")"}let c=document.getElementById("reply-template").content.cloneNode(!0),h=c.firstElementChild,[g,R]=c.querySelectorAll(".reply-profile-info a span");g.textContent=e?"":"@"+s,R.textContent=e?"":"@"+l;let L=h.getElementsByClassName("reply-contents")[0];L.innerHTML=e?'<i style="color: grey">[deleted]</i>':I;let p=c.querySelector(".reply-top > img");p.src=e?"":"/image_proxy/"+encodeURIComponent(x)+"/replies/"+encodeURIComponent(n),p.style.backgroundColor=v(g.innerText+R.innerText),e&&(p.alt="");let S=c.querySelector(".reply-profile-info > a");S.href=A;let[q,C]=c.querySelectorAll(".reply-profile-info > span");q.textContent=e?"[deleted]":r||s,C.textContent=y;let E=c.querySelector(".reply-op-button > a");E.href=i;let[b,a]=c.querySelectorAll(".reply-controls > a");if(new URL(i).host==="mastodon.social"?b.href=i:b.href=w+n,e||l==="bsky.brid.gy")a.href=i;else{let d=s+"."+l+".ap.brid.gy";a.addEventListener("click",async D=>{if(console.log(a.href),a.getAttribute("href")==="#"){D.preventDefault();let T=await f(d,"",i);a.href=T,a.click()}})}return o.appendChild(c),h}async function j(){return B()}j();})();
